name: Mirror Gitee to GitHub

on:
  schedule:
    - cron: "*/30 * * * *"   # 每30分钟同步
  workflow_dispatch:         # 手动触发

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Git identity
        run: |
          git config --global user.name "${{ secrets.GITEE_USERNAME }}"
          git config --global user.email "${{ secrets.GITEE_USERNAME }}@gitee.com"

      - name: Clone from Gitee (mirror)
        run: |
          git clone --mirror \
            https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_ACCESS_TOKEN }}@gitee.com/${{ secrets.GITEE_REPO }}.git \
            repo

      - name: Configure GitHub remote safely
        run: |
          cd repo
          git remote add github https://${{ secrets.MY_GITHUB_USERNAME }}:${{ secrets.MY_GITHUB_TOKEN }}@github.com/${{ secrets.MY_GITHUB_REPO }}.git

      - name: Push to GitHub (safe mirror)
        run: |
          cd repo

          # 删除 Gitee 中的 PR refs，避免 GitHub 拒绝 push
          rm -rf refs/pull || true
          rm -rf refs/changes || true

          # 只镜像 branches + tags（不推送 PR hidden refs）
          git push github --prune \
            +refs/heads/*:refs/heads/* \
            +refs/tags/*:refs/tags/*

      - name: Cleanup credentials
        if: always()
        run: |
          git config --global --unset credential.helper || true
          rm -rf ~/.git-credentials || true
